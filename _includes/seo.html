{% comment %}
Custom SEO include with multilingual support
Overrides the default Minimal Mistakes SEO
{% endcomment %}

{% assign current_lang = page.lang | default: site.default_language | default: 'ko' %}
{% assign lang_metadata = site.language_metadata[current_lang] %}
{% assign localized_site_title = lang_metadata.site_title | default: site.title %}
{% assign localized_site_description = lang_metadata.site_description | default: site.description %}

{% comment %}Page title with language support{% endcomment %}
{% if page.seo_title %}
  {% assign seo_title = page.seo_title %}
{% elsif page.title %}
  {% assign seo_title = page.title | append: " - " | append: localized_site_title %}
{% else %}
  {% assign seo_title = localized_site_title %}
{% endif %}

{% comment %}Page description with language support{% endcomment %}
{% if page.description %}
  {% assign seo_description = page.description %}
{% elsif page.excerpt %}
  {% assign seo_description = page.excerpt | strip_html | truncate: 160 %}
{% else %}
  {% assign seo_description = localized_site_description %}
{% endif %}

<title>{{ seo_title | escape }}</title>
<meta name="description" content="{{ seo_description | escape }}">
<meta name="language" content="{{ current_lang }}">
<meta http-equiv="content-language" content="{{ current_lang }}">
<meta name="content-language" content="{{ current_lang }}">
<meta name="dc.language" content="{{ current_lang }}">
{% if lang_metadata.locale %}
<meta name="locale" content="{{ lang_metadata.locale }}">
{% endif %}

{% if page.author %}
  <meta name="author" content="{{ page.author | escape }}">
{% elsif site.author.name %}
  <meta name="author" content="{{ site.author.name | escape }}">
{% endif %}

{% if page.layout == 'post' %}
  <meta property="article:author" content="{{ page.author | default: site.author.name | escape }}">
{% endif %}

<!-- Open Graph / Facebook -->
<meta property="og:type" content="{% if page.layout == 'post' %}article{% else %}website{% endif %}">
<meta property="og:locale" content="{{ lang_metadata.locale | default: 'ko_KR' }}">
<meta property="og:site_name" content="{{ localized_site_title | escape }}">
<meta property="og:title" content="{{ page.title | default: localized_site_title | escape }}">
<meta property="og:url" content="{{ page.url | absolute_url }}{% unless current_lang == site.default_language %}?lang={{ current_lang }}{% endunless %}">
<meta property="og:description" content="{{ seo_description | escape }}">

{% if page.image %}
  <meta property="og:image" content="{{ page.image | absolute_url }}">
{% elsif site.og_image %}
  <meta property="og:image" content="{{ site.og_image | absolute_url }}">
{% else %}
  <meta property="og:image" content="{{ '/assets/images/og-image.jpg' | absolute_url }}">
{% endif %}

{% if page.image_alt %}
  <meta property="og:image:alt" content="{{ page.image_alt | escape }}">
{% endif %}

<!-- Twitter -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="{{ page.title | default: localized_site_title | escape }}">
<meta name="twitter:description" content="{{ seo_description | escape }}">

{% if page.image %}
  <meta name="twitter:image" content="{{ page.image | absolute_url }}">
{% elsif site.og_image %}
  <meta name="twitter:image" content="{{ site.og_image | absolute_url }}">
{% else %}
  <meta name="twitter:image" content="{{ '/assets/images/og-image.jpg' | absolute_url }}">
{% endif %}

<!-- Article specific tags -->
{% if page.layout == 'post' %}
  <meta property="article:published_time" content="{{ page.date | date_to_xmlschema }}">
  {% if page.updated or page.last_modified_at %}
    <meta property="article:modified_time" content="{{ page.updated | default: page.last_modified_at | date_to_xmlschema }}">
  {% endif %}
  {% if page.categories %}
    {% for category in page.categories %}
      <meta property="article:section" content="{{ category | escape }}">
    {% endfor %}
  {% endif %}
  {% if page.tags %}
    {% for tag in page.tags %}
      <meta property="article:tag" content="{{ tag | escape }}">
    {% endfor %}
  {% endif %}
{% endif %}

<!-- Canonical URL -->
<link rel="canonical" href="{{ page.url | absolute_url }}{% unless current_lang == site.default_language %}?lang={{ current_lang }}{% endunless %}">

<!-- Language alternates and hreflang tags -->
{% include hreflang-tags.html %}

{% comment %}
Jekyll SEO Tag 플러그인에서 기본 JSON-LD를 생성하고,
여기서는 번역 정보만 추가로 생성합니다.
{% endcomment %}

{% if page.translation_key %}
  {% assign translations = site.posts | where: "translation_key", page.translation_key %}
  {% if translations.size > 1 %}
<!-- Translation Information JSON-LD -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "WebPage",
  "url": "{{ page.url | absolute_url }}",
  "inLanguage": "{{ current_lang }}",
  "workTranslation": [
    {% for translation in translations %}
      {% unless translation.lang == current_lang %}
        {
          "@type": "CreativeWork",
          "url": "{{ translation.url | absolute_url }}",
          "inLanguage": "{{ translation.lang }}",
          "name": "{{ translation.title | escape }}"
        }{% unless forloop.last %},{% endunless %}
      {% endunless %}
    {% endfor %}
  ]
}
</script>
  {% endif %}
{% endif %}